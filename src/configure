#! /bin/bash
ROOT_PATH=`pwd`
MAKEFILE_CONF=Makefile.conf
MAKEFILE_SUB=Makefile.sub

F_SRC=$1
FRAMA_C_INCLUDES="-I ${F_SRC}/src/kernel -I ${F_SRC}/src/project -I
${F_SRC}/cil/ocamlutil -I ${F_SRC}/cil/src/logic -I ${F_SRC}/cil/src -I
${F_SRC}/cil/src/ext -I ${F_SRC}/src/lib -I .  -I ${F_SRC}/lib/fc -I
${ROOT_PATH}/SSL/ -I ${ROOT_PATH}/global_mem/"
HEADER="FRAMA_C_INCLUDES=${FRAMA_C_INCLUDES}"
[[ -e ${MAKEFILE_CONF} ]] && rm -f ${MAKEFILE_CONF}
echo -e ${HEADER} >> ${MAKEFILE_CONF}

build_makefile () {
  [[ -e $1/${MAKEFILE_SUB} ]] && rm -f $1/${MAKEFILE_SUB}
  echo "include ${ROOT_PATH}/${MAKEFILE_CONF}" >> $1/${MAKEFILE_SUB} &&\
  echo "include ${ROOT_PATH}/${MAKEFILE_SUB}.in" >> $1/${MAKEFILE_SUB} &&\
  echo "#### GENERATED BY OCAML DEP, DO NOT EDIT ! ###" >> $1/${MAKEFILE_SUB} &&\
  cd $1 && ocamldep -native ${FRAMA_C_INCLUDES} *.mli *.ml >> ${MAKEFILE_SUB}; cd ${ROOT_PATH}
}

[[ -e Makefile ]] && rm -f Makefile 
echo ".PHONY: clean all" >> Makefile

echo "all:" >> makefile
echo -e "\t@cd ssl/ && make -f makefile.sub && cd ${root_path}" >> makefile
echo -e "\t@cd c_upon_sslandnts_sem/ && make -f makefile.sub && cd ${root_path}" >> makefile
echo -e "\t@cd global_mem/ && make -f makefile.sub && cd ${root_path}" >> makefile
echo -e "\t@cd ./ && make -f makefile.sub && cd ${root_path}" >> makefile

echo "clean:" >> makefile
echo -e "\t@cd ssl/ && make -f makefile.sub clean && cd ${root_path}" >> makefile
echo -e "\t@cd c_upon_sslandnts_sem/ && make -f makefile.sub clean && cd ${root_path}" >> makefile
echo -e "\t@cd global_mem/ && make -f makefile.sub clean && cd ${root_path}" >> makefile
echo -e "\t@cd ./ && make -f makefile.sub clean && cd ${root_path}" >> makefile

build_makefile "SSL/"
build_makefile "c_upon_sslandnts_sem/"
build_makefile "global_mem/"
build_makefile "./"
