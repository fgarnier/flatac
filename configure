#! /bin/bash 
# FlataC Configure Script. #
# Maxime Gaudin, 2011.     #
############################

SRC_DIR=`pwd`/src
OBJ_DIR=${SRC_DIR}

MAKEFILE_CONF_NAME=Makefile.conf
MKCONF=${SRC_DIR}/${MAKEFILE_CONF_NAME}

SUB_MAKEFILE_NAME=Makefile.sub
SUBMK=${SRC_DIR}/${SUB_MAKEFILE_NAME}.in

build_configuration_file () {
  echo "* Configuring build pipeline ..."

  FRAMA_C_INCLUDES="-I $1/src/kernel \
    -I $1/src/project \
    -I $1/cil/ocamlutil \
    -I $1/cil/src/logic \
    -I $1/cil/src \
    -I $1/cil/src/ext \
    -I $1/src/lib \
    -I . \
    -I $1/lib/fc \
    -I ${SRC_DIR}/"

  echo -e "FRAMA_C_INCLUDES=${FRAMA_C_INCLUDES}" > ${MKCONF}
  echo -e "FRAMAC_SHARE:=`frama-c.byte -print-path`" >> ${MKCONF}
  echo -e "FRAMAC_LIBDIR:=`frama-c.byte -print-libpath`" >> ${MKCONF}
}

build_sub_makefile () {
  SUB_MAKEFILE=${SRC_DIR}/$1/${SUB_MAKEFILE_NAME} 

  echo "** $1 ..."

  echo "include ${MKCONF}" > ${SUB_MAKEFILE} &&\
  echo "include ${SUBMK}" >> ${SUB_MAKEFILE} &&\
  echo "#### GENERATED BY OCAML DEP, DO NOT EDIT ! ###" >> ${SUB_MAKEFILE} &&\
  cd ${SRC_DIR}/$1 && ocamldep -native ${FRAMA_C_INCLUDES} *.mli *.ml >> ${SUB_MAKEFILE_NAME} &&\
  echo "##############################################" >> ${SUB_MAKEFILE} &&\
  echo "include custom.deps" >> ${SUB_MAKEFILE} 

  cd ${SRC_DIR}
}

build_sub_makefiles () {
  echo "* Building sub-makefiles ..."

  for i in $1
  do
      build_sub_makefile $i
  done
}

export_rules () {
  echo -e "\t@echo \"Construction de $1...\"" >> Makefile
  echo -e "\t@cd ${SRC_DIR}/$1 && make -f Makefile.sub" >> Makefile
  echo -e "\t@cd ${SRC_DIR}/$1 && cp -f *.cmo *.cmx *.cmi *.o ${OBJ_DIR} 2>/dev/null ; cd ${SRC_DIR}" >> Makefile
  echo -e "\t@echo \"\"" >> Makefile
}

build_global_makefile () {
  echo "* Building global makefile ..."

  [[ -e Makefile ]] && rm -f Makefile 
  echo ".PHONY: clean all" >> Makefile

  echo "all:" >> Makefile
  for i in $1
  do
    export_rules $i
  done
  echo -e "\t@echo \"Enregistrement du plugin...\"" >> Makefile
  echo -e "\t@cd ${OBJ_DIR}/ && make -f FC_Makefile && cd ${SRC_DIR}" >> Makefile
  echo -e "\t@echo \"\"" >> Makefile
  echo -e "\t@echo \"*** Compilation terminÃ©e ***\"" >> Makefile

  echo "install:" >> Makefile
  echo -e "\t@cd ${OBJ_DIR}/ && make -f FC_Makefile install && cd ${SRC_DIR}" >> Makefile

  echo "clean:" >> Makefile
  for i in $1
  do
    echo -e "\t@cd ${SRC_DIR}/$i && make -f Makefile.sub clean && cd ${SRC_DIR}" >> Makefile
  done
  echo -e "\t@cd ${OBJ_DIR}/ && make -f FC_Makefile clean && cd ${SRC_DIR}" >> Makefile
}

build_configuration_file $1

build_global_makefile "SSL/ global_mem/ c_upon_sslandnts_sem/"
build_sub_makefiles "SSL/ global_mem/ c_upon_sslandnts_sem/"

echo ""
echo "Configuration done."
echo "type : make && make install"
