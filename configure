#! /bin/bash
ROOT_PATH=`pwd`/src
OBJ_DIR=${ROOT_PATH}/

MAKEFILE_CONF=Makefile.conf
MAKEFILE_SUB=Makefile.sub

F_SRC=$1
FRAMA_C_INCLUDES="-I ${F_SRC}/src/kernel \
-I ${F_SRC}/src/project \
-I ${F_SRC}/cil/ocamlutil \
-I ${F_SRC}/cil/src/logic \
-I ${F_SRC}/cil/src \
-I ${F_SRC}/cil/src/ext \
-I ${F_SRC}/src/lib \
-I . \
-I ${F_SRC}/lib/fc \
-I ${ROOT_PATH}/"

HEADER=""
[[ -e ${ROOT_PATH}/${MAKEFILE_CONF} ]] && rm -f ${ROOT_PATH}/${MAKEFILE_CONF}
echo -e "FRAMA_C_INCLUDES=${FRAMA_C_INCLUDES}" >> ${ROOT_PATH}/${MAKEFILE_CONF}
echo -e "FRAMAC_SHARE:=`frama-c.byte -print-path`" >> ${ROOT_PATH}/${MAKEFILE_CONF}
echo -e "FRAMAC_LIBDIR:=`frama-c.byte -print-libpath`" >> ${ROOT_PATH}/${MAKEFILE_CONF}

build_makefile () {
  [[ -e ${ROOT_PATH}/$1/${MAKEFILE_SUB} ]] && rm -f ${ROOT_PATH}/$1/${MAKEFILE_SUB}
  echo "include ${ROOT_PATH}/${MAKEFILE_CONF}" >> ${ROOT_PATH}/$1/${MAKEFILE_SUB} &&\
  echo "include ${ROOT_PATH}/${MAKEFILE_SUB}.in" >> ${ROOT_PATH}/$1/${MAKEFILE_SUB} &&\
  echo "#### GENERATED BY OCAML DEP, DO NOT EDIT ! ###" >> ${ROOT_PATH}/$1/${MAKEFILE_SUB} &&\
  cd ${ROOT_PATH}/$1 && ocamldep -native ${FRAMA_C_INCLUDES} *.mli *.ml >> ${MAKEFILE_SUB}; cd ${ROOT_PATH}
}

export () {
  echo -e "\t@echo \"Construction de $1...\"" >> Makefile
  echo -e "\t@cd ${ROOT_PATH}/$1 && make -f Makefile.sub" >> Makefile
  echo -e "\t@cd ${ROOT_PATH}/$1 && cp -f *.cmo *.cmx *.cmi *.o ${OBJ_DIR} 2>/dev/null ; cd ${ROOT_PATH}" >> Makefile
  echo -e "\t@echo \"\"" >> Makefile
}

[[ -e Makefile ]] && rm -f Makefile 
echo ".PHONY: clean all" >> Makefile

echo "all:" >> Makefile
export "SSL/"
export "global_mem/"
export "c_upon_sslandnts_sem/"
export "./"

echo -e "\t@echo \"Enregistrement du plugin...\"" >> Makefile
echo -e "\t@cd ${OBJ_DIR}/ && make -f FC_Makefile && make -f \
FC_Makefile install && cd ${ROOT_PATH}" >> Makefile
echo -e "\t@echo \"\"" >> Makefile

echo -e "\t@echo \"*** Compilation terminÃ©e ***\"" >> Makefile

echo "clean:" >> Makefile
echo -e "\t@cd ${ROOT_PATH}/SSL/ && make -f Makefile.sub clean && cd ${ROOT_PATH}" >> Makefile
echo -e "\t@cd ${ROOT_PATH}/c_upon_sslandnts_sem/ && make -f Makefile.sub clean && cd ${ROOT_PATH}" >> Makefile
echo -e "\t@cd ${ROOT_PATH}/global_mem/ && make -f Makefile.sub clean && cd ${ROOT_PATH}" >> Makefile
echo -e "\t@cd ${ROOT_PATH}/./ && make -f Makefile.sub clean && cd ${ROOT_PATH}" >> Makefile
echo -e "\t@cd ${OBJ_DIR}/ && make -f FC_Makefile clean && cd ${ROOT_PATH}" >> Makefile

build_makefile "SSL/"
build_makefile "global_mem/"
build_makefile "c_upon_sslandnts_sem/"
build_makefile "./"
